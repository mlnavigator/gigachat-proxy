## Микросервис обертка клиента гигачата.

### Настройка и запуск

Создайте env файл с переменными окружения в папке assets

Проще всего скопировав файл env_example.txt, заполнив нужные значения окружения (не забудьте удалить все комментарии в файле env).

Настройте поведение сервиса через переменные окружения

Запустите приложение через `python3 <path_to>/app.py`

Либо вы можете запустить через использование Docker. Для Linux запуск в докер контейнере через `/bin/bash ./rebuild.sh`
 - будет собран и запущен контейнер с именем gigachat_proxy.

Если вы будете менять порт по умолчанию, и запускать через докер, то порт надо изменить не только в ./assets/env, 
но и в скриптах запуска докер контейнера /run.sh и ./rebuild.sh

В env в качестве GIGACHAT_API_KEY используется "Ключ авторизации" (англ. Authorization key) — строка, 
полученная в результате кодирования в Base64 клиентского идентификатора (Client ID) и ключа (Client Secret) API.

Задача микросервиса - все влетевшие запросы выстроить в очередь и отправлять во внешнее апи с гигачатом с учетом ограничений.
Доступные ограничения очереди

    - EXT_API_RPM - сколько максимум запросов в минуту, те запросы будут отправляться во внешнее апи не чаще чем 1 раз в 60/RPM секунд
    - EXT_MAX_REQUESTS - сколько одновременно запросов во внешнее апи будет отправлено
    - EXP_RESP_TIMEOUT - сколько ждать ответа от внешнего апи

### Пример данных для отправки в proxy service

```
req_data = {
    'messages': [('system', 'Ты робот киска, на все вопросы отвечай мяу-мяу'),
                ('user', 'Привет, как дела?')],
    'generate_parameters': {'temperature': 1,
       'top_p': 0,
       'repetition_penalty': 1,
       'max_tokens': 2000,
       'model': 'GigaChat-Max',
       'profanity_check': False,
       }
}
```

Параметры для генерации 'generate_parameters' будут проброшены в Гигачат, актуальную документацию смотрите в документации к Гигачату.

Cсылка на документацию к АПИ Гигачата

[https://developers.sber.ru/docs/ru/gigachat/api/reference/rest/gigachat-api](https://developers.sber.ru/docs/ru/gigachat/api/reference/rest/gigachat-api)


### Пример использования 

Пример использования апи представлен в файле api_client_example.py

Приведенный пример клиента полностью повторяет интерфейс класса GigaChat в части использования метода GigaChat.chat из оригинальной библиотеки gigachat

### Микросервис как шаблон обертки любого апи с контролем нагрузки

Вы можете использовать данный проект в качестве шаблона для обертки любого другого внешнего апи сервиса.

Для этого вам достаточно просто переписать gigachat_connecor - замените его на любой другой коннектор к вашему внешнему апи.

Модуль коннектора должен реализовывать три метода
    - validate_data(data)
    - request_api(data)
    - get_info()
    
Замените в модуле proxy_request строку `from gigachat_connector import validate_data, request_api, get_info` 
на `from <my_connector> import validate_data, request_api, get_info`

Так же при сборке через докер - лучше поменяйте имя контейнера в .sh скриптах
